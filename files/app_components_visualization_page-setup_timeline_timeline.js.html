<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>app/components/visualization/page-setup/timeline/timeline.js - ExplorViz Frontend</title>
    <link rel="stylesheet" href="">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="stylesheet" href="../assets/css/custom.css">
    <link rel="stylesheet" href="../assets/vendor/bootstrap/css/bootstrap.css">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
</head>
<body class="yui3-skin-sam">
<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <h1 class="brand" style="padding: 10px 16px 10px; height: 20px; line-height: 20px; margin-left: 0;">
	    <img alt="ExplorViz Frontend" src="https://www.explorviz.net/img/slideshow/explorviz-logo.png" style="max-height: 65%;" title="ExplorViz Frontend">
            ExplorViz Frontend
        </h1>
	<div class="nav">
            <li class="divider-vertical"></li>
            <li>
                <p class="navbar-text">
                    API Docs for Version: <b>1.3.0</b>
                </p>
            </li>
        </div>
        <form class="navbar-form pull-right" style="line-height: 40px; height: 40px;">
            <input style="margin-top: 0;" type="text" class="search-query" placeholder="Search for classes/modules..." data-obj='["classes/Agent-Adapter", "classes/Alertify-Handler", "classes/Application-Controller", "classes/Application-Rendering-Component", "classes/Application-Route", "classes/Application-Serializer", "classes/Authenticator", "classes/Badroute-Route", "classes/Configuration-Controller", "classes/Configuration-Route", "classes/Configuration-Service", "classes/Index-Route", "classes/Landscape-Adapter", "classes/Landscape-Rendering-Component", "classes/Landscape-Serializer", "classes/Login-Form-Component", "classes/Login-Route", "classes/Procezz-Adapter", "classes/Rendering-Core-Component", "classes/Router", "classes/System-Serializer", "classes/ThreeJS-Performance-Mixin", "classes/Timeline-Component", "classes/Timestamp-Adapter", "classes/Visualization-Controller", "classes/Visualization-Route", "modules/explorviz", "modules/explorviz.discovery", "modules/model", "modules/model.meta", "modules/model.util", "modules/network", "modules/page", "modules/security", "modules/settings", "modules/visualization", "modules/visualization.page-setup.timeline", "modules/visualization.rendering", "modules/visualization.timeshift"]'>
        </form>
    </div>
</div>
<div class="container">
    <div class="row">
        <div class="span3">
	    <div>
	        <h3>APIs</h3>
	        <div id="sidebar">
	            <ul id="main-nav" class="nav nav-tabs" style="margin-bottom:0;">
	                <li class="active"><a href="#classes" data-toggle="tab">Classes</a></li>
	                <li><a href="#modules" data-toggle="tab">Modules</a></li>
	            </ul>
	    
	            <div id="api-tabview-filter">
	                <input type="search" placeholder="Type to filter APIs">
	            </div>
	    
	            <div class="tab-content" style="border: 1px solid #DDD; border-top:0;">
	                <div class="tab-pane active" id="classes">
	                    <ul id="api-classes" class="nav nav-list">
	                            <li><a href="../classes/Agent-Adapter.html">Agent-Adapter</a></li>
	                            <li><a href="../classes/Alertify-Handler.html">Alertify-Handler</a></li>
	                            <li><a href="../classes/Application-Controller.html">Application-Controller</a></li>
	                            <li><a href="../classes/Application-Rendering-Component.html">Application-Rendering-Component</a></li>
	                            <li><a href="../classes/Application-Route.html">Application-Route</a></li>
	                            <li><a href="../classes/Application-Serializer.html">Application-Serializer</a></li>
	                            <li><a href="../classes/Authenticator.html">Authenticator</a></li>
	                            <li><a href="../classes/Badroute-Route.html">Badroute-Route</a></li>
	                            <li><a href="../classes/Configuration-Controller.html">Configuration-Controller</a></li>
	                            <li><a href="../classes/Configuration-Route.html">Configuration-Route</a></li>
	                            <li><a href="../classes/Configuration-Service.html">Configuration-Service</a></li>
	                            <li><a href="../classes/Index-Route.html">Index-Route</a></li>
	                            <li><a href="../classes/Landscape-Adapter.html">Landscape-Adapter</a></li>
	                            <li><a href="../classes/Landscape-Rendering-Component.html">Landscape-Rendering-Component</a></li>
	                            <li><a href="../classes/Landscape-Serializer.html">Landscape-Serializer</a></li>
	                            <li><a href="../classes/Login-Form-Component.html">Login-Form-Component</a></li>
	                            <li><a href="../classes/Login-Route.html">Login-Route</a></li>
	                            <li><a href="../classes/Procezz-Adapter.html">Procezz-Adapter</a></li>
	                            <li><a href="../classes/Rendering-Core-Component.html">Rendering-Core-Component</a></li>
	                            <li><a href="../classes/Router.html">Router</a></li>
	                            <li><a href="../classes/System-Serializer.html">System-Serializer</a></li>
	                            <li><a href="../classes/ThreeJS-Performance-Mixin.html">ThreeJS-Performance-Mixin</a></li>
	                            <li><a href="../classes/Timeline-Component.html">Timeline-Component</a></li>
	                            <li><a href="../classes/Timestamp-Adapter.html">Timestamp-Adapter</a></li>
	                            <li><a href="../classes/Visualization-Controller.html">Visualization-Controller</a></li>
	                            <li><a href="../classes/Visualization-Route.html">Visualization-Route</a></li>
	                    </ul>
	                </div>
	    
	                <div class="tab-pane" id="modules">
	                    <ul id="api-modules" class="nav nav-list">
	                            <li><a href="../modules/explorviz.html">explorviz</a></li>
	                            <li><a href="../modules/explorviz.discovery.html">explorviz.discovery</a></li>
	                            <li><a href="../modules/model.html">model</a></li>
	                            <li><a href="../modules/model.meta.html">model.meta</a></li>
	                            <li><a href="../modules/model.util.html">model.util</a></li>
	                            <li><a href="../modules/network.html">network</a></li>
	                            <li><a href="../modules/page.html">page</a></li>
	                            <li><a href="../modules/security.html">security</a></li>
	                            <li><a href="../modules/settings.html">settings</a></li>
	                            <li><a href="../modules/visualization.html">visualization</a></li>
	                            <li><a href="../modules/visualization.page-setup.timeline.html">visualization.page-setup.timeline</a></li>
	                            <li><a href="../modules/visualization.rendering.html">visualization.rendering</a></li>
	                            <li><a href="../modules/visualization.timeshift.html">visualization.timeshift</a></li>
	                    </ul>
	                </div>
	            </div>
	        </div>
	    </div>
        </div>
        <div class="span9">
                <form id="options-form" class="form-inline pull-right">
                    Show:
                    <label for="api-show-inherited" class="checkbox">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected" class="checkbox">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private" class="checkbox">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated" class="checkbox">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </form>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<div class="page-header">
    <h1>app/components/visualization/page-setup/timeline/timeline.js <small>File</small></h1>
</div>

<div class="file">
    <pre class="prettyprint linenums">
import Component from &#x27;@ember/component&#x27;;
import { inject as service } from &quot;@ember/service&quot;;
import Evented from &#x27;@ember/object/evented&#x27;;
import AlertifyHandler from &#x27;explorviz-frontend/mixins/alertify-handler&#x27;;
import debugLogger from &#x27;ember-debug-logger&#x27;;
import { timestampToDate } from &#x27;explorviz-frontend/helpers/timestamp-to-date&#x27;;

import Chart from &quot;chart.js&quot;;
import $ from &#x27;jquery&#x27;;

/**
 * Renderer for athe timeline.
 *
 * @class Timeline-Component
 *
 * @module explorviz
 * @submodule visualization.page-setup.timeline
 */
export default Component.extend(AlertifyHandler, Evented, {

    // No Ember generated container
    tagName: &#x27;&#x27;,

    debug: debugLogger(),

    store: service(),
    timestampRepo: service(&quot;repos/timestamp-repository&quot;),
    landscapeListener: service(&quot;landscape-listener&quot;),
    reloadHandler: service(&quot;reload-handler&quot;),

    timelineChart: null,
    lastHighlightedElementIndex: null,
    canvas: null,

    chartColors: null,
    maxNumOfDataPoints: null,

    listeners: null,


    // @Override
    /**
     * This overridden Ember Component lifecycle hook enables calling
     * ExplorViz&#x27;s setup code for actual rendering and custom listeners.
     *
     * @method didRender
     */
    didRender() {
        this._super(...arguments);
        this.initChart();
        this.renderChart();
        this.initListener();
    },

    // @Override
    /**
     * This overridden Ember Component lifecycle hook enables calling
     * ExplorViz&#x27;s custom cleanup code.
     *
     * @method willDestroyElement
     */
    willDestroyElement() {
        this._super(...arguments);
        this.cleanup();
    },

    /**
     * This function is called when the willDestroyElement event is fired. Inherit this
     * function to cleanup custom properties or unbind listener
     *
     * @method cleanup
     */
    cleanup() {
        this.set(&#x27;timelineChart&#x27;, null);

        // unsubscribe from all services
        this.get(&#x27;listeners&#x27;).forEach(([service, event, listenerFunction]) =&gt; {
            this.get(service).off(event, listenerFunction);
        });
        this.set(&#x27;listeners&#x27;, null);
    },

    /**
     * Inititializes &quot;updated&quot; listener
     * @method initListener
     */
    initListener() {
        this.set(&#x27;listeners&#x27;, new Set());

        // listener for when a new timestamp (data point) arrives
        this.get(&#x27;listeners&#x27;).add([
            &#x27;timestampRepo&#x27;,
            &#x27;updated&#x27;,
            (newTimestamp) =&gt; {
                this.onUpdated(newTimestamp);
            }
        ]);

        // listener for when the visualization is resumed from the navbar
        this.get(&#x27;listeners&#x27;).add([
            &#x27;landscapeListener&#x27;,
            &#x27;visualizationResumed&#x27;,
            () =&gt; {
                this.onLandscapeListenerVisualizationResumed();
            }
        ]);

        // start subscriptions
        this.get(&#x27;listeners&#x27;).forEach(([service, event, listenerFunction]) =&gt; {
            this.get(service).on(event, listenerFunction);
        });
    },

    /**
     * Initializes default settings for the chart
     * @method initChart
     */
    initChart() {
        const self = this;

        // referencing the canvas
        self.set(&#x27;canvas&#x27;, $(&#x27;#timelineCanvas&#x27;).get(0));

        // setting the default colors for highlighting and resetting purposes
        const color = Chart.helpers.color;

        self.set(&#x27;chartColors&#x27;, {
            default: {
                backgroundColor: color(&#x27;rgb(0, 123, 255)&#x27;).alpha(0.5).rgbString(),
                borderColor: &#x27;rgba(0,0,0,0.1)&#x27;,
                radius: &#x27;3&#x27;
            },
            highlighted: {
                backgroundColor: &#x27;red&#x27;,
                borderColor: &#x27;black&#x27;,
                radius: &#x27;4&#x27;
            }
        });

        // setting the maximum number of data points shown in the timeline
        self.set(&#x27;maxNumOfDataPoints&#x27;, 10);
    },

    /**
     * Renders the timeline chart
     * @method renderChart
     */
    renderChart() {
        const self = this;

        self.debug(&quot;start timeline init&quot;);

        const backgroundColor = self.get(&#x27;chartColors.default.backgroundColor&#x27;);
        const borderColor = self.get(&#x27;chartColors.default.borderColor&#x27;);

        // chart data
        var chartValues = [];
        var chartLabels = [];

        // setting the context for the chart
        var ctx = $(&#x27;#timelineCanvas&#x27;).get(0).getContext(&#x27;2d&#x27;);

        // Chart configuration
        var chartConfig = {
            type: &#x27;line&#x27;,
            data: {
                labels: chartLabels,
                datasets: [{
                    label: &#x27;Requests&#x27;,
                    backgroundColor: backgroundColor,
                    borderColor: borderColor,
                    data: chartValues,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        left: 0,
                        right: 35,
                        top: 25,
                        bottom: 0
                    }
                },
                tooltips: {
                    enabled: true,
                    mode: &#x27;point&#x27;,
                },
                legend: {
                    display: false
                },
                scales: {
                    xAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: &#x27;Time&#x27;,
                            fontStyle: &#x27;bold&#x27;
                        },
                        type: &#x27;time&#x27;,
                        distribution: &#x27;series&#x27;,
                        time: {
                            unit: &#x27;second&#x27;,
                            displayFormats: {
                                second: &#x27;HH:mm:ss&#x27;
                            },
                            tooltipFormat: &#x27;DD.MM.YYYY - kk:mm:ss&#x27;
                        },
                        ticks: {
                            source: &#x27;labels&#x27;,
                        }
                    }],
                    yAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: &#x27;Total Requests&#x27;,
                            fontStyle: &#x27;bold&#x27;
                        },
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                },
                // performance optimizations
                elements: {
                    line: {
                        tension: 0, // disables bezier curves
                    }
                },
                &#x27;onClick&#x27;: function (evt) {
                    self.chartClickHandler(evt);
                },
            }
        };

        var timelineChart = new Chart(ctx, chartConfig);
        self.set(&#x27;timelineChart&#x27;, timelineChart);

        self.debug(&quot;end timeline init&quot;);
    },

    /**
     * Clickhandler for the chart
     * @method chartClickhandler
     * @param {*} evt 
     */
    chartClickHandler(evt) {
        const self = this;

        const timelineChart = self.get(&#x27;timelineChart&#x27;);

        const colorsDefault = self.get(&#x27;chartColors.default&#x27;);
        const colorsHighlighted = self.get(&#x27;chartColors.highlighted&#x27;);

        var activePoint = timelineChart.getElementAtEvent(evt)[0];
        const lastHighlightedElementIndex = self.get(&#x27;lastHighlightedElementIndex&#x27;);

        // data point clicked - only one data point is highlighted at a time
        if (activePoint) {
            var data = activePoint._chart.data;
            var datasetIndex = activePoint._datasetIndex;
            var elementIndex = activePoint._index;
            var retrievedTimestamp = data.datasets[datasetIndex].data[elementIndex].x;

            // data point was already highlighted
            if (lastHighlightedElementIndex === elementIndex) {
                // do nothing
            } else {
                // highlight clicked data point
                timelineChart.getDatasetMeta(datasetIndex).data[elementIndex].custom = colorsHighlighted;

                // reset the style of the previous data point
                if (lastHighlightedElementIndex) {
                    timelineChart.getDatasetMeta(datasetIndex).data[lastHighlightedElementIndex].custom = colorsDefault;
                }

                // save the index of the clicked data point
                self.set(&#x27;lastHighlightedElementIndex&#x27;, elementIndex);

                self.set(&#x27;timelineChart&#x27;, timelineChart);
                timelineChart.update();

                // load specific landscape and pause visulization

                // convert timestamp to readable date for notification
                const formattedTimestamp = timestampToDate([retrievedTimestamp]);

                self.showAlertifyMessage(&quot;Loading landscape [&quot; + formattedTimestamp + &quot;]&quot;);
                self.handleNotificationMessage(false);

                self.get(&#x27;reloadHandler&#x27;).loadLandscapeById(retrievedTimestamp);
            }
        } else {
            // reset the style of the previous data point and unpause the visualization
            if (lastHighlightedElementIndex) {

                timelineChart.getDatasetMeta(0).data[lastHighlightedElementIndex].custom = colorsDefault;

                self.set(&#x27;lastHighlightedElementIndex&#x27;, null);

                self.set(&#x27;timelineChart&#x27;, timelineChart);
                timelineChart.update();

                self.handleNotificationMessage(true);

            }
            // TODO 
            // maybe Bug within ChartJS? The first data point can&#x27;t be unhighlighted like the others
            else {
                self.unhighlightFirstDataPoint();
            }
        }
    },

    /**
     * Resets the style of first data point in the chart
     * @method unhighlightFirstDataPoint
     */
    unhighlightFirstDataPoint() {
        const self = this;

        const timelineChart = self.get(&#x27;timelineChart&#x27;);

        const colorsDefault = self.get(&#x27;chartColors.default&#x27;);

        timelineChart.getDatasetMeta(0).data[0].custom = colorsDefault;

        self.set(&#x27;lastHighlightedElementIndex&#x27;, null);
        self.set(&#x27;timelineChart&#x27;, timelineChart);
        timelineChart.update();

        if (self.get(&#x27;landscapeListener&#x27;).pauseVisualizationReload) {
            self.handleNotificationMessage(true);
        }
    },

    /**
     * Unhighlights all previosly selected data points in the chart
     * @method unhighlightAllDataPoints
     */
    unhighlightAllDataPoints() {
        const self = this;

        const timelineChart = self.get(&#x27;timelineChart&#x27;);
        const colorsDefault = self.get(&#x27;chartColors.default&#x27;);
        const lastHighlightedElementIndex = self.get(&#x27;lastHighlightedElementIndex&#x27;);

        if (lastHighlightedElementIndex) {
            timelineChart.getDatasetMeta(0).data[lastHighlightedElementIndex].custom = colorsDefault;
        }

        self.unhighlightFirstDataPoint();
    },

    /**
     * Updates the timeline chart when &quot;updated&quot; is triggered
     * @method updateChart
     */
    updateChart(newTimestamp) {
        const self = this;

        self.debug(&quot;start timeline update&quot;);

        const updatedTimelineChart = self.get(&#x27;timelineChart&#x27;);

        const colorsDefault = self.get(&#x27;chartColors.default&#x27;);

        const numOfDataPoints = updatedTimelineChart.data.datasets[0].data.length;
        const maxNumOfDataPoints = this.get(&#x27;maxNumOfDataPoints&#x27;);

        const timestamp = newTimestamp.get(&#x27;timestamp&#x27;);
        const totalRequests = newTimestamp.get(&#x27;totalRequests&#x27;);

        const newTimelineData = {
            x: timestamp,
            y: totalRequests
        };

        // remove oldest timestamp in timeline to keep a fixed number of data points
        if (numOfDataPoints &gt;= maxNumOfDataPoints) {
            updatedTimelineChart.data.datasets[0].data.shift();
            updatedTimelineChart.data.labels.shift();
        }

        updatedTimelineChart.data.datasets[0].data.push(newTimelineData);
        updatedTimelineChart.data.labels.push(timestamp);

        // reset the color of the previous data point
        const lastHighlightedElementIndex = self.get(&#x27;lastHighlightedElementIndex&#x27;);

        if (lastHighlightedElementIndex) {
            updatedTimelineChart.getDatasetMeta(0).data[lastHighlightedElementIndex].custom = colorsDefault;

            self.set(&#x27;lastHighlightedElementIndex&#x27;, null);
        }

        self.set(&#x27;timelineChart&#x27;, updatedTimelineChart);
        updatedTimelineChart.update();

        self.debug(&quot;end timeline update&quot;);
    },

    /**
     * Called when a new timestamp is passed and the chart needs to be updated
     * @method onUpdated
     * @param {*} newTimestamp 
     */
    onUpdated(newTimestamp) {
        this.updateChart(newTimestamp);
    },

    /**
     * Called when the landscapeListener.startVisualizationReload is executed
     * @method onLandscapeListenerVisualizationResumed
     */
    onLandscapeListenerVisualizationResumed(){
        this.unhighlightAllDataPoints();
    },

    /**
     * Displays a notifaction message  and resumes/pauses the visualization
     * @method handleNotificationMessage
     * @param {true, false} pause (true: pause -&gt; resume, false: resume -&gt; pause )
     */
    handleNotificationMessage(pause) {
        if (pause) {
            this.showAlertifyMessage(&quot;Visualization resumed!&quot;);
            this.get(&#x27;landscapeListener&#x27;).startVisualizationReload();
        }
        else {
            this.showAlertifyMessage(&quot;Visualization paused!&quot;);
            this.get(&#x27;landscapeListener&#x27;).stopVisualizationReload();
        }
    }

});
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/jquery/jquery-1.8.2.min.js"></script>
<script src="../assets/vendor/bootstrap/js/bootstrap.js"></script>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script src="../assets/js/yuidoc-bootstrap.js"></script>
<script>prettyPrint();</script>
</body>
</html>
