<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>app/components/visualization/rendering/rendering-core.js - ExplorViz Frontend</title>
    <link rel="stylesheet" href="">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="stylesheet" href="../assets/css/custom.css">
    <link rel="stylesheet" href="../assets/vendor/bootstrap/css/bootstrap.css">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
</head>
<body class="yui3-skin-sam">
<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <h1 class="brand" style="padding: 10px 16px 10px; height: 20px; line-height: 20px; margin-left: 0;">
	    <img alt="ExplorViz Frontend" src="https://www.explorviz.net/img/slideshow/explorviz-logo.png" style="max-height: 65%;" title="ExplorViz Frontend">
            ExplorViz Frontend
        </h1>
	<div class="nav">
            <li class="divider-vertical"></li>
            <li>
                <p class="navbar-text">
                    API Docs for Version: <b>1.3.0</b>
                </p>
            </li>
        </div>
        <form class="navbar-form pull-right" style="line-height: 40px; height: 40px;">
            <input style="margin-top: 0;" type="text" class="search-query" placeholder="Search for classes/modules..." data-obj='["classes/Agent-Adapter", "classes/Application-Rendering-Component", "classes/Application-Route", "classes/Application-Serializer", "classes/Authenticator", "classes/Badroute-Route", "classes/Configuration-Route", "classes/Index-Route", "classes/Landscape-Adapter", "classes/Landscape-Rendering-Component", "classes/Landscape-Serializer", "classes/Login-Form-Component", "classes/Login-Route", "classes/Procezz-Adapter", "classes/Rendering-Core-Component", "classes/Router", "classes/System-Serializer", "classes/Timeline-Component", "classes/Timestamp-Adapter", "classes/Visualization-Controller", "classes/Visualization-Route", "modules/explorviz", "modules/explorviz.discovery", "modules/model", "modules/model.meta", "modules/model.util", "modules/network", "modules/page", "modules/security", "modules/settings", "modules/visualization", "modules/visualization.page-setup.timeline", "modules/visualization.rendering", "modules/visualization.timeshift"]'>
        </form>
    </div>
</div>
<div class="container">
    <div class="row">
        <div class="span3">
	    <div>
	        <h3>APIs</h3>
	        <div id="sidebar">
	            <ul id="main-nav" class="nav nav-tabs" style="margin-bottom:0;">
	                <li class="active"><a href="#classes" data-toggle="tab">Classes</a></li>
	                <li><a href="#modules" data-toggle="tab">Modules</a></li>
	            </ul>
	    
	            <div id="api-tabview-filter">
	                <input type="search" placeholder="Type to filter APIs">
	            </div>
	    
	            <div class="tab-content" style="border: 1px solid #DDD; border-top:0;">
	                <div class="tab-pane active" id="classes">
	                    <ul id="api-classes" class="nav nav-list">
	                            <li><a href="../classes/Agent-Adapter.html">Agent-Adapter</a></li>
	                            <li><a href="../classes/Application-Rendering-Component.html">Application-Rendering-Component</a></li>
	                            <li><a href="../classes/Application-Route.html">Application-Route</a></li>
	                            <li><a href="../classes/Application-Serializer.html">Application-Serializer</a></li>
	                            <li><a href="../classes/Authenticator.html">Authenticator</a></li>
	                            <li><a href="../classes/Badroute-Route.html">Badroute-Route</a></li>
	                            <li><a href="../classes/Configuration-Route.html">Configuration-Route</a></li>
	                            <li><a href="../classes/Index-Route.html">Index-Route</a></li>
	                            <li><a href="../classes/Landscape-Adapter.html">Landscape-Adapter</a></li>
	                            <li><a href="../classes/Landscape-Rendering-Component.html">Landscape-Rendering-Component</a></li>
	                            <li><a href="../classes/Landscape-Serializer.html">Landscape-Serializer</a></li>
	                            <li><a href="../classes/Login-Form-Component.html">Login-Form-Component</a></li>
	                            <li><a href="../classes/Login-Route.html">Login-Route</a></li>
	                            <li><a href="../classes/Procezz-Adapter.html">Procezz-Adapter</a></li>
	                            <li><a href="../classes/Rendering-Core-Component.html">Rendering-Core-Component</a></li>
	                            <li><a href="../classes/Router.html">Router</a></li>
	                            <li><a href="../classes/System-Serializer.html">System-Serializer</a></li>
	                            <li><a href="../classes/Timeline-Component.html">Timeline-Component</a></li>
	                            <li><a href="../classes/Timestamp-Adapter.html">Timestamp-Adapter</a></li>
	                            <li><a href="../classes/Visualization-Controller.html">Visualization-Controller</a></li>
	                            <li><a href="../classes/Visualization-Route.html">Visualization-Route</a></li>
	                    </ul>
	                </div>
	    
	                <div class="tab-pane" id="modules">
	                    <ul id="api-modules" class="nav nav-list">
	                            <li><a href="../modules/explorviz.html">explorviz</a></li>
	                            <li><a href="../modules/explorviz.discovery.html">explorviz.discovery</a></li>
	                            <li><a href="../modules/model.html">model</a></li>
	                            <li><a href="../modules/model.meta.html">model.meta</a></li>
	                            <li><a href="../modules/model.util.html">model.util</a></li>
	                            <li><a href="../modules/network.html">network</a></li>
	                            <li><a href="../modules/page.html">page</a></li>
	                            <li><a href="../modules/security.html">security</a></li>
	                            <li><a href="../modules/settings.html">settings</a></li>
	                            <li><a href="../modules/visualization.html">visualization</a></li>
	                            <li><a href="../modules/visualization.page-setup.timeline.html">visualization.page-setup.timeline</a></li>
	                            <li><a href="../modules/visualization.rendering.html">visualization.rendering</a></li>
	                            <li><a href="../modules/visualization.timeshift.html">visualization.timeshift</a></li>
	                    </ul>
	                </div>
	            </div>
	        </div>
	    </div>
        </div>
        <div class="span9">
                <form id="options-form" class="form-inline pull-right">
                    Show:
                    <label for="api-show-inherited" class="checkbox">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected" class="checkbox">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private" class="checkbox">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated" class="checkbox">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </form>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<div class="page-header">
    <h1>app/components/visualization/rendering/rendering-core.js <small>File</small></h1>
</div>

<div class="file">
    <pre class="prettyprint linenums">
import Component from &#x27;@ember/component&#x27;;
import { inject as service } from &#x27;@ember/service&#x27;;
import Evented from &#x27;@ember/object/evented&#x27;;
import THREE from &quot;three&quot;;
import THREEPerformance from &#x27;explorviz-frontend/utils/threejs-performance&#x27;;
import debugLogger from &#x27;ember-debug-logger&#x27;;
import $ from &#x27;jquery&#x27;;

/**
* This component contains the core mechanics of the different (three.js-based)
* renderer. All functions below are called in a determined order, hence you only
* need to override them in your custom renderer.
*
* See {{#crossLink &quot;Landscape-Rendering&quot;}}{{/crossLink}} or
* {{#crossLink &quot;Application-Rendering&quot;}}{{/crossLink}} for example usage.
*
* Call order:
*
* 1.
*
* @class Rendering-Core-Component
* @extends Ember.Component
*
* @module explorviz
* @submodule visualization.rendering
*/
export default Component.extend(Evented, {

  // No Ember generated container
  tagName: &#x27;&#x27;,

  debug: debugLogger(),

  state: null,

  highlighter: service(&quot;visualization/application/highlighter&quot;),
  landscapeRepo: service(&quot;repos/landscape-repository&quot;),
  additionalData: service(),
  configuration: service(),
  reloadHandler: service(),
  renderingService: service(),

  currentUser: service(),

  scene: null,
  webglrenderer: null,
  camera: null,

  canvas: null,

  font: null,
  animationFrameId: null,

  initDone: false,

  appCondition: null,
  initImport: true,

  listeners: null,

  threePerformance: null,

  init() {
    this._super(...arguments);
    this.set(&#x27;appCondition&#x27;, []);
  },


  // @Override
  /**
   * This overridden Ember Component lifecycle hook enables calling
   * ExplorViz&#x27;s setup code for actual rendering and custom listeners.
   *
   * @method didRender
   */
  didRender() {
    this._super(...arguments);
    this.initRendering();
    this.initListener();
  },


  // @Override
  /**
   * This overridden Ember Component lifecycle hook enables calling
   * ExplorViz&#x27;s custom cleanup code.
   *
   * @method willDestroyElement
   */
  willDestroyElement() {
    this._super(...arguments);
    this.cleanup();
  },


  /**
   * This function is called once on the didRender event. Inherit this function
   * to call other important function, e.g. &quot;initInteraction&quot; as shown in
   * {{#crossLink &quot;Landscape-Rendering/initInteraction:method&quot;}}{{/crossLink}}.
   *
   * @method initRenderings
   */
  initRendering() {
    this.debug(&#x27;init rendering-core&#x27;);

    const self = this;

    // Get size if outer ember div
    const height = $(&#x27;#rendering&#x27;).innerHeight();
    const width = $(&#x27;#rendering&#x27;).innerWidth();

    const canvas = $(&#x27;#threeCanvas&#x27;)[0];

    this.set(&#x27;canvas&#x27;, canvas);

    this.set(&#x27;scene&#x27;, new THREE.Scene());
    const backgroundColor = this.get(&#x27;configuration.landscapeColors.background&#x27;);
    this.set(&#x27;scene.background&#x27;, new THREE.Color(backgroundColor));

    this.set(&#x27;camera&#x27;, new THREE.PerspectiveCamera(75, width / height, 0.1, 1000));

    this.set(&#x27;webglrenderer&#x27;, new THREE.WebGLRenderer({
      antialias: true,
      canvas: canvas
    }));
    this.get(&#x27;webglrenderer&#x27;).setPixelRatio(window.devicePixelRatio);
    this.get(&#x27;webglrenderer&#x27;).setSize(width, height);

    let showFpsCounter = this.get(&#x27;currentUser&#x27;).getPreferenceOrDefaultValue(&#x27;flagsetting&#x27;, &#x27;showFpsCounter&#x27;);

    if (showFpsCounter) {
      this.threePerformance = new THREEPerformance();
    }

    // Rendering loop //
    function render() {
      if (self.get(&#x27;isDestroyed&#x27;)) {
        return;
      }

      const animationId = requestAnimationFrame(render);
      self.set(&#x27;animationFrameId&#x27;, animationId);

      if (showFpsCounter) {
        self.threePerformance.threexStats.update(self.get(&#x27;webglrenderer&#x27;));
        self.threePerformance.stats.begin();
      }

      self.get(&#x27;webglrenderer&#x27;).render(self.get(&#x27;scene&#x27;), self.get(&#x27;camera&#x27;));

      if (showFpsCounter) {
        self.threePerformance.stats.end();
      }
    }

    render();

    ////////////////////

    // Load font for labels and synchronously proceed with populating the scene
    new THREE.FontLoader().load(
      // resource URL
      &#x27;/three.js/fonts/roboto_mono_bold_typeface.json&#x27;,

      // onLoad callback
      function ( font ) {

        if (self.isDestroyed)
          return;

        self.set(&#x27;font&#x27;, font);
        self.debug(&quot;(THREE.js) font sucessfully loaded.&quot;);
        self.set(&#x27;initDone&#x27;, true);
        self.populateScene();
      },

      // onProgress callback
      // function ( xhr ) {
      //   self.debug(&quot;(THREE.js) font &quot; + (xhr.loaded / xhr.total * 100) + &quot;% loaded.&quot;);
      // },

      // onError callback
      // function ( error ) {
      //   self.debug(&quot;(THREE.js) Error when loading font!&quot;);
      // }  
    );

  },


  updateCanvasSize() {
    const outerDiv = $(&#x27;#vizspace&#x27;)[0];

    if (outerDiv) {
      if (!this.get(&#x27;camera&#x27;) || !this.get(&#x27;webglrenderer&#x27;))
        return;

      $(&#x27;#threeCanvas&#x27;).hide();

      const height = Math.round($(&#x27;#rendering&#x27;).innerHeight());
      const width = Math.round($(&#x27;#rendering&#x27;).innerWidth());

      this.set(&#x27;camera.aspect&#x27;, width / height);
      this.get(&#x27;camera&#x27;).updateProjectionMatrix();

      this.get(&#x27;webglrenderer&#x27;).setSize(width, height);

      this.onResized();

      $(&#x27;#threeCanvas&#x27;).show();
    }
  },


  initListener() {
    this.set(&#x27;listeners&#x27;, new Set());

    this.get(&#x27;listeners&#x27;).add([
      &#x27;renderingService&#x27;,
      &#x27;reSetupScene&#x27;,
      () =&gt; {
        this.onReSetupScene();
      }
    ]);

    this.get(&#x27;listeners&#x27;).add([
      &#x27;renderingService&#x27;,
      &#x27;resizeCanvas&#x27;,
      () =&gt; {
        this.updateCanvasSize();
      }
    ]);

    this.get(&#x27;listeners&#x27;).add([
      &#x27;renderingService&#x27;,
      &#x27;moveCameraTo&#x27;,
      (emberModel) =&gt; {
        this.onMoveCameraTo(emberModel);
      }
    ]);

    this.get(&#x27;listeners&#x27;).add([
      &#x27;landscapeRepo&#x27;,
      &#x27;updated&#x27;,
      () =&gt; {
        this.onUpdated();
      }
    ]);

    // start subscriptions
    this.get(&#x27;listeners&#x27;).forEach(([service, event, listenerFunction]) =&gt; {
        this.get(service).on(event, listenerFunction);
    });
  },

  /*
   *  This method is used to collect data about the landscape.
   *  Ids of closed systems and nodegroups are stored in an array
   */
  computeLandscapeCondition() {
    const systems = this.get(&#x27;landscapeRepo.latestLandscape&#x27;).get(&#x27;systems&#x27;);
    const condition = [];

    systems.forEach(function (system) {

      // Exclude requests
      if (system.get(&#x27;name&#x27;) !== &quot;Requests&quot;) {
        // Handle closed systems and add id to array
        if (!system.get(&#x27;opened&#x27;)) {
          condition.push(system.get(&#x27;id&#x27;));
        }
        // Handle opened systems
        else {
          // Handle closed nodegroups and add id to array
          const nodegroups = system.get(&#x27;nodegroups&#x27;);
          nodegroups.forEach(function (nodegroup) {
            if (!nodegroup.get(&#x27;opened&#x27;)) {
              condition.push(nodegroup.get(&#x27;id&#x27;));
            }
          });
        }
      }
    });
    return condition;
  },

  /*
   *  This method is used to collect data about the application.
   *  Names of opened packages are stored in an array.
   *  Furthermore the name+highlighted of the
   *  highlighted package is stored
   */
  computeAppCondition(components, clazzes) {
    if (clazzes) {
      clazzes.forEach((clazz) =&gt; {
        if (clazz.get(&#x27;highlighted&#x27;)) {
          this.get(&#x27;appCondition&#x27;).push(clazz.get(&#x27;name&#x27;).concat(&quot;highlighted&quot;));
        }
      });
    }

    components.forEach((component) =&gt; {
      // Handle opened packages and add name to array
      if (component.get(&#x27;opened&#x27;)) {
        this.get(&#x27;appCondition&#x27;).push(component.get(&#x27;name&#x27;));
        this.computeAppCondition(component.get(&#x27;children&#x27;), component.get(&#x27;clazzes&#x27;));
      }
      // Handle closed and highlighted packages
      else if (component.get(&#x27;highlighted&#x27;)) {
        this.get(&#x27;appCondition&#x27;).push(component.get(&#x27;name&#x27;).concat(&quot;highlighted&quot;));
      }
    });
  },


  /*
   *  This method is used to open and close specified systems
   *  and nodegroups. The array &#x27;condition&#x27; contains the ids of
   *  of all closed systems and nodegroups
   */
  applyLandscapeCondition(landscape) {
    const systems = landscape.get(&#x27;systems&#x27;);

    systems.forEach((system) =&gt; {
      
      if (system.get(&#x27;name&#x27;) !== &quot;Requests&quot;) {

        // Open system
        system.setOpened(true);
        for (var i = 0; i &lt; this.get(&#x27;condition&#x27;).length; i++) {

          // Close system if id is in condition
          if (parseFloat(system.get(&#x27;id&#x27;)) === parseFloat(this.get(&#x27;condition&#x27;)[i])) {
            system.setOpened(false);
          }
        }

        // Check condition of nodegroups if system is opened
        if (system.get(&#x27;opened&#x27;)) {
          const nodegroups = system.get(&#x27;nodegroups&#x27;);

          nodegroups.forEach(function (nodegroup) {

            // Open nodegroup
            nodegroup.setOpened(true);
            for (var i = 0; i &lt; this.get(&#x27;condition&#x27;).length; i++) {

              // Close nodegroup if id is in condition
              if (parseFloat(nodegroup.get(&#x27;id&#x27;)) === parseFloat(this.get(&#x27;condition&#x27;)[i])) {
                nodegroup.setOpened(false);
              }
            }
          });
        }
      }
    });
  },

  applyAppCondition(application) {
    if (!application) {
      return;
    }

    // Get clazzes of application
    let components = null;
    if (this.get(&#x27;initImport&#x27;)) {
      components = application.get(&#x27;components&#x27;);
      this.set(&#x27;initImport&#x27;, false);
    }
    else {
      components = application.get(&#x27;children&#x27;);
    }

    const clazzes = application.get(&#x27;clazzes&#x27;);

    // Set states of clazzes
    if (clazzes) {
      clazzes.forEach(function (clazz) {
        // Look for highlighted clazzes
        for (var i = 0; i &lt; this.get(&#x27;condition&#x27;).length; i++) {
          if (clazz.get(&#x27;name&#x27;).concat(&quot;highlighted&quot;) === this.get(&#x27;condition&#x27;)[i]) {
            clazz.set(&#x27;highlighted&#x27;, true);
          }
        }
      });
    }

    // Set states if components
    if (components) {
      components.forEach(function (component) {
        // Close component
        component.setOpenedStatus(false);
        for (var i = 0; i &lt; this.get(&#x27;condition&#x27;).length; i++) {
          // Open component if name is in condition
          if (component.get(&#x27;name&#x27;) === this.get(&#x27;condition&#x27;)[i]) {
            component.setOpenedStatus(true);
            this.applyAppCondition(component);
          }
          // Case not opened =&gt; maybe highlighted
          else if (component.get(&#x27;name&#x27;).concat(&quot;highlighted&quot;) === this.get(&#x27;condition&#x27;)[i]) {
            component.set(&#x27;highlighted&#x27;, true);
          }
        }
      });
      this.cleanAndUpdateScene();
    }
  },

  /**
   * This function is called once on initRendering and everytime at the end of
   * &quot;cleanAndUpdateScene&quot;. Inherit this function to insert objects in the
   * Three.js scene. Have a look at
   * {{#crossLink &quot;Landscape-Rendering/cleanAndUpdateScene:method&quot;}}
   * {{/crossLink}}
   * or
   * {{#crossLink &quot;Application-Rendering/cleanAndUpdateScene:method&quot;}}
   * {{/crossLink}}
   * for examplary usage.
   *
   * @method populateScene
   */
  populateScene() { },

  /**
   * This function is called when the willDestroyElement event is fired. Inherit this
   * function to cleanup custom properties or unbind listener
   * as shown in {{#crossLink &quot;Landscape-Rendering&quot;}}{{/crossLink}}.
   *
   * @method cleanup
   */
  cleanup() {
    cancelAnimationFrame(this.get(&#x27;animationFrameId&#x27;));

    this.set(&#x27;scene&#x27;, null);
    this.set(&#x27;webglrenderer&#x27;, null);

    // Clean up WebGL rendering context by forcing context loss
    var gl = this.get(&#x27;canvas&#x27;).getContext(&#x27;webgl&#x27;);
    gl.getExtension(&#x27;WEBGL_lose_context&#x27;).loseContext();

    this.set(&#x27;camera&#x27;, null);

    if(this.threePerformance) {
      this.threePerformance.removePerformanceMeasurement();
    }

    // unsubscribe from all services
    this.get(&#x27;listeners&#x27;).forEach(([service, event, listenerFunction]) =&gt; {
      this.get(service).off(event, listenerFunction);
    });
    this.set(&#x27;listeners&#x27;, null);

    this.get(&#x27;highlighter&#x27;).unhighlightAll();
    this.get(&#x27;additionalData&#x27;).emptyAndClose();
  },

  /**
   * Inherit this function to update the scene with a new renderingModel. It
   * automatically removes every mesh from the scene and finally calls
   * the (overridden) &quot;populateScene&quot; function. Add your custom code
   * as shown in landscape-rendering.
   *
   * @method cleanAndUpdateScene
   */
  cleanAndUpdateScene() {
    const scene = this.get(&#x27;scene&#x27;);

    removeAllChildren(scene);

    function removeAllChildren(entity) {
      for (let i = entity.children.length - 1; i &gt;= 0; i--) {
        let child = entity.children[i];

        removeAllChildren(child);

        if (child.type !== &#x27;AmbientLight&#x27; &amp;&amp; child.type !== &#x27;SpotLight&#x27; &amp;&amp; child.type !== &#x27;DirectionalLight&#x27;) {
          if (child.type !== &#x27;Object3D&#x27;) {
            child.geometry.dispose();
            child.material.dispose();
          }
          entity.remove(child);
        }
      }
    }
    this.populateScene();
  },


  /**
   * This function is called automatically when a new landscape was fetched. It
   * is executed before
   * {{#crossLink &quot;Rendering-Core/cleanAndUpdateScene:method&quot;}}{{/crossLink}}.
   * Inherit this function to preprocess the
   * {{#crossLink &quot;Landscape&quot;}}{{/crossLink}} for rendering, e.g. filter some
   * value.
   *
   * See {{#crossLink &quot;Application-Rendering&quot;}}{{/crossLink}} for example usage.
   *
   * @method preProcessEntity
   */
  preProcessEntity() { },
  

  // Listener-Callbacks. Override in extending components

  onReSetupScene() {
    this.cleanAndUpdateScene();
  },

  onUpdated() {
    this.cleanAndUpdateScene();
  },

  onResized() {
    this.cleanAndUpdateScene();
  },

  onMoveCameraTo() {},

});

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/jquery/jquery-1.8.2.min.js"></script>
<script src="../assets/vendor/bootstrap/js/bootstrap.js"></script>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script src="../assets/js/yuidoc-bootstrap.js"></script>
<script>prettyPrint();</script>
</body>
</html>
